<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Evaluator ‚Äì Fundamentalanalyse</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --accent: #5b6bff;
      --accent2: #9b59b6;
      --green: #27ae60;
      --orange: #e67e22;
      --red: #e74c3c;
      --bg: #f0f2ff;
      --card: #fff;
      --border: #e0e3f0;
      --text: #1a1d2e;
      --muted: #6b7280;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      color: white;
      padding: 28px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    header h1 { font-size: 1.6em; font-weight: 700; }
    header p  { font-size: 0.9em; opacity: .8; }
    #last-updated { font-size: 0.82em; opacity: .75; }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs {
      display: flex;
      gap: 0;
      background: var(--card);
      border-bottom: 2px solid var(--border);
      padding: 0 24px;
      overflow-x: auto;
    }
    .tab-btn {
      padding: 14px 22px;
      border: none;
      background: none;
      font-size: 0.95em;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      white-space: nowrap;
      transition: color .2s, border-color .2s;
    }
    .tab-btn:hover { color: var(--accent); }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .container { max-width: 1300px; margin: 0 auto; padding: 24px 16px; }

    /* ‚îÄ‚îÄ Search view ‚îÄ‚îÄ */
    .search-grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 20px;
    }
    @media (max-width: 900px) { .search-grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 2px 12px rgba(91,107,255,.08);
      border: 1px solid var(--border);
    }
    .card h2 { font-size: 1.05em; margin-bottom: 16px; color: var(--text); }

    /* Search box */
    .search-row { display: flex; gap: 8px; margin-bottom: 14px; }
    .search-row input {
      flex: 1; padding: 10px 14px; border: 2px solid var(--border);
      border-radius: 8px; font-size: 0.95em; outline: none;
      transition: border-color .2s;
    }
    .search-row input:focus { border-color: var(--accent); }
    .btn {
      padding: 10px 20px; background: var(--accent); color: #fff;
      border: none; border-radius: 8px; font-weight: 700;
      cursor: pointer; font-size: 0.95em; transition: background .2s;
    }
    .btn:hover { background: var(--accent2); }

    /* Error */
    .error-msg {
      background: #fdecea; color: var(--red); padding: 10px 14px;
      border-radius: 8px; font-size: 0.9em; margin-bottom: 12px;
      display: none;
    }
    .error-msg.show { display: block; }

    /* Watchlist */
    .watchlist-list { max-height: 320px; overflow-y: auto; }
    .wl-item {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 12px; border-radius: 8px;
      cursor: pointer; margin-bottom: 6px;
      border: 1px solid var(--border);
      transition: background .15s;
    }
    .wl-item:hover { background: #f0f2ff; }
    .wl-symbol { font-weight: 700; flex: 1; font-size: 0.95em; }
    .wl-score {
      background: var(--accent); color: #fff;
      padding: 3px 10px; border-radius: 20px; font-size: 0.82em; font-weight: 700;
    }
    .wl-remove {
      background: none; border: none; color: var(--red);
      cursor: pointer; font-size: 1.1em; line-height: 1; padding: 2px 4px;
    }
    .empty-msg { text-align: center; color: var(--muted); padding: 30px 0; font-size: 0.9em; }

    /* ‚îÄ‚îÄ Stock result card ‚îÄ‚îÄ */
    #result-panel { display: none; }
    .stock-header {
      display: flex; justify-content: space-between;
      align-items: flex-start; margin-bottom: 22px;
      padding-bottom: 18px; border-bottom: 2px solid var(--border);
      flex-wrap: wrap; gap: 12px;
    }
    .stock-name-block h3 { font-size: 1.5em; font-weight: 800; }
    .stock-name-block p  { color: var(--muted); font-size: 0.88em; margin-top: 4px; }
    .price-block { text-align: right; }
    .price-block .price { font-size: 1.6em; font-weight: 800; color: var(--accent); }
    .price-block .currency { color: var(--muted); font-size: 0.85em; }

    .overall-score {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff; border-radius: 10px; padding: 22px;
      text-align: center; margin-bottom: 20px;
    }
    .overall-score .num  { font-size: 3em; font-weight: 900; }
    .overall-score .lbl  { font-size: 1em; opacity: .9; }
    .overall-score .desc { font-size: 0.85em; opacity: .75; margin-top: 6px; }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px; margin-bottom: 18px;
    }
    .metric-card {
      border: 1px solid var(--border); border-radius: 8px;
      padding: 14px; background: #fafbff;
    }
    .metric-card .m-label { font-size: 0.8em; color: var(--muted); margin-bottom: 4px; }
    .metric-card .m-value { font-size: 1.15em; font-weight: 700; color: var(--accent); }
    .metric-card .m-score { font-size: 0.78em; color: var(--muted); margin-top: 4px; }

    .add-wl-btn {
      width: 100%; padding: 12px; background: var(--accent);
      color: #fff; border: none; border-radius: 8px;
      font-weight: 700; font-size: 1em; cursor: pointer; transition: background .2s;
    }
    .add-wl-btn:hover { background: var(--accent2); }
    .add-wl-btn.added { background: var(--green); }

    /* ‚îÄ‚îÄ Market rankings ‚îÄ‚îÄ */
    .market-controls {
      display: flex; align-items: center; gap: 14px;
      margin-bottom: 20px; flex-wrap: wrap;
    }
    .market-controls select {
      padding: 10px 14px; border: 2px solid var(--border);
      border-radius: 8px; font-size: 0.95em; cursor: pointer;
      background: #fff; outline: none; transition: border-color .2s;
    }
    .market-controls select:focus { border-color: var(--accent); }

    .rankings-table { width: 100%; border-collapse: collapse; }
    .rankings-table thead tr {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #fff;
    }
    .rankings-table th,
    .rankings-table td { padding: 12px 14px; text-align: left; }
    .rankings-table th { font-weight: 600; font-size: 0.9em; }
    .rankings-table tbody tr { border-bottom: 1px solid var(--border); transition: background .15s; }
    .rankings-table tbody tr:hover { background: #f0f2ff; cursor: pointer; }
    .rank-num { font-weight: 800; color: var(--accent); font-size: 1.05em; }
    .score-badge {
      display: inline-block; padding: 4px 12px;
      border-radius: 20px; font-weight: 700; font-size: 0.85em; color: #fff;
    }
    .score-high { background: var(--green); }
    .score-mid  { background: var(--orange); }
    .score-low  { background: var(--red); }

    /* Loader */
    .loader { display: none; text-align: center; padding: 40px; color: var(--muted); }
    .loader.show { display: block; }
    .spinner {
      width: 36px; height: 36px; border: 4px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* tab panes */
    .pane { display: none; }
    .pane.active { display: block; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>üìà Stock Evaluator</h1>
    <p>Fundamentalanalyse ‚Äì Daten via yfinance</p>
  </div>
  <div id="last-updated">Lade Daten‚Ä¶</div>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="search">üîç Einzelne Aktie</button>
  <button class="tab-btn" data-tab="market">üìä Markt Rankings</button>
</div>

<!-- ‚îÄ‚îÄ Search Tab ‚îÄ‚îÄ -->
<div id="pane-search" class="pane active">
  <div class="container">
    <div class="search-grid">

      <!-- Left: search + watchlist -->
      <div>
        <div class="card" style="margin-bottom:16px;">
          <h2>üîç Aktie suchen</h2>
          <div class="search-row">
            <input id="search-input" type="text" placeholder="Symbol z.B. AAPL, SAP.DE">
            <button class="btn" id="search-btn">Suchen</button>
          </div>
          <div class="error-msg" id="search-error"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <h2 style="margin:0;">‚≠ê Watchlist</h2>
            <button class="btn" style="padding:6px 14px;font-size:0.85em;" id="clear-wl">Leeren</button>
          </div>
          <div class="watchlist-list" id="watchlist">
            <div class="empty-msg">Noch keine Aktien gespeichert</div>
          </div>
        </div>
      </div>

      <!-- Right: result -->
      <div>
        <div class="card" id="result-panel">
          <div id="result-content"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Market Tab ‚îÄ‚îÄ -->
<div id="pane-market" class="pane">
  <div class="container">
    <div class="card">
      <div class="market-controls">
        <select id="market-select">
          <option value="sp500">S&P 500 ‚Äì USA</option>
          <option value="nasdaq">NASDAQ 100 ‚Äì Technologie</option>
          <option value="dax">DAX ‚Äì Deutschland</option>
          <option value="ftse">FTSE 100 ‚Äì UK</option>
          <option value="cac">CAC 40 ‚Äì Frankreich</option>
          <option value="nikkei">Nikkei 225 ‚Äì Japan</option>
        </select>
        <span id="market-meta" style="color:var(--muted);font-size:0.9em;"></span>
      </div>
      <div class="loader" id="market-loader"><div class="spinner"></div><p>Lade‚Ä¶</p></div>
      <div style="overflow-x:auto;">
        <table class="rankings-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Symbol</th>
              <th>Name</th>
              <th>Preis</th>
              <th>KGV</th>
              <th>KBV</th>
              <th>ROE</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="market-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ Global state ‚îÄ‚îÄ */
let DB = null;          // loaded data.json
let watchlist = JSON.parse(localStorage.getItem("wl") || "[]");

/* ‚îÄ‚îÄ Load data.json once ‚îÄ‚îÄ */
async function loadData() {
  try {
    const r = await fetch("data.json?_=" + Date.now());
    if (!r.ok) throw new Error("data.json not found");
    DB = await r.json();
    document.getElementById("last-updated").textContent =
      "Zuletzt aktualisiert: " + new Date(DB.updated).toLocaleString("de-DE");
    renderMarket(document.getElementById("market-select").value);
  } catch(e) {
    document.getElementById("last-updated").textContent =
      "‚ö†Ô∏è Keine Daten ‚Äì bitte GitHub Actions ausf√ºhren";
  }
}

/* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".pane").forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("pane-" + btn.dataset.tab).classList.add("active");
  });
});

/* ‚îÄ‚îÄ Market rankings ‚îÄ‚îÄ */
document.getElementById("market-select").addEventListener("change", e => {
  renderMarket(e.target.value);
});

function renderMarket(marketId) {
  const tbody = document.getElementById("market-tbody");
  const meta  = document.getElementById("market-meta");
  tbody.innerHTML = "";
  if (!DB) { meta.textContent = "Daten werden geladen‚Ä¶"; return; }

  const market = DB.markets[marketId];
  if (!market) { meta.textContent = "Markt nicht gefunden"; return; }

  meta.textContent = market.stocks.length + " Unternehmen";

  market.stocks.forEach((s, i) => {
    const badgeClass = s.score >= 70 ? "score-high" : s.score >= 45 ? "score-mid" : "score-low";
    const priceStr = s.price != null ? s.price.toLocaleString("de-DE", {minimumFractionDigits:2,maximumFractionDigits:2}) + " " + s.currency : "‚Äì";
    const pe  = s.metrics.pe   != null ? s.metrics.pe.toFixed(1) : "‚Äì";
    const pb  = s.metrics.pb   != null ? s.metrics.pb.toFixed(2) : "‚Äì";
    const roe = s.metrics.roe  != null ? s.metrics.roe.toFixed(1) + "%" : "‚Äì";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="rank-num">${i+1}</td>
      <td><strong>${s.symbol}</strong></td>
      <td>${s.name}</td>
      <td>${priceStr}</td>
      <td>${pe}</td>
      <td>${pb}</td>
      <td>${roe}</td>
      <td><span class="score-badge ${badgeClass}">${s.score}</span></td>
    `;
    tr.addEventListener("click", () => {
      showStockFromDB(s);
      document.querySelector('[data-tab="search"]').click();
    });
    tbody.appendChild(tr);
  });
}

/* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
document.getElementById("search-btn").addEventListener("click", doSearch);
document.getElementById("search-input").addEventListener("keydown", e => {
  if (e.key === "Enter") doSearch();
});

function doSearch() {
  const sym = document.getElementById("search-input").value.trim().toUpperCase();
  const err = document.getElementById("search-error");
  err.className = "error-msg";
  if (!sym) { showError("Bitte ein Symbol eingeben"); return; }
  if (!DB)  { showError("Daten noch nicht geladen"); return; }

  // search across all markets
  let found = null;
  for (const mkt of Object.values(DB.markets)) {
    const s = mkt.stocks.find(x => x.symbol.toUpperCase() === sym);
    if (s) { found = s; break; }
  }

  if (!found) {
    showError(`"${sym}" nicht in den Daten gefunden. Bitte in der Watchlist oder Marktliste suchen.`);
  } else {
    showStockFromDB(found);
  }
}

function showError(msg) {
  const err = document.getElementById("search-error");
  err.textContent = msg;
  err.className = "error-msg show";
}

function showStockFromDB(s) {
  document.getElementById("search-error").className = "error-msg";
  document.getElementById("result-panel").style.display = "block";

  const m = s.metrics;
  const fmt = (v, suffix="", digits=2) => v != null ? v.toLocaleString("de-DE",{minimumFractionDigits:digits,maximumFractionDigits:digits}) + suffix : "‚Äì";
  const scoreLabel = s.score >= 80 ? "Exzellent üü¢" : s.score >= 60 ? "Gut üü°" : s.score >= 40 ? "Durchschnitt üü†" : "Schwach üî¥";

  const metricsHTML = [
    { label: "KGV (P/E)",            value: fmt(m.pe, "", 2),         score: s.scoreDetails?.pe },
    { label: "KBV (P/B)",            value: fmt(m.pb, "", 2),         score: s.scoreDetails?.pb },
    { label: "ROE",                   value: fmt(m.roe, "%", 1),       score: s.scoreDetails?.roe },
    { label: "Bruttomarge",           value: fmt(m.grossMargin, "%",1),score: s.scoreDetails?.grossMargin },
    { label: "Nettomarge",            value: fmt(m.netMargin, "%",1),  score: s.scoreDetails?.netMargin },
    { label: "Verschuldungsgrad D/E", value: fmt(m.debtToEquity,"",2), score: s.scoreDetails?.debtToEquity },
    { label: "Current Ratio",         value: fmt(m.currentRatio,"",2), score: s.scoreDetails?.currentRatio },
    { label: "Umsatzwachstum",        value: fmt(m.revenueGrowth,"%",1),score: s.scoreDetails?.revenueGrowth },
    { label: "KPS (P/S)",            value: fmt(m.ps,"",2) },
    { label: "EPS",                  value: fmt(m.eps,"",2) },
    { label: "Vortagesschluss",      value: fmt(m.previousClose, " " + s.currency, 2) },
    { label: "Dividendenrendite",    value: fmt(m.dividendYield,"%",2) },
  ].map(row => {
    const scoreStr = row.score
      ? `<div class="m-score">${row.score.score}/${row.score.max} Pkt.</div>`
      : "";
    return `<div class="metric-card">
      <div class="m-label">${row.label}</div>
      <div class="m-value">${row.value}</div>
      ${scoreStr}
    </div>`;
  }).join("");

  const inWL = watchlist.some(w => w.symbol === s.symbol);
  document.getElementById("result-content").innerHTML = `
    <div class="stock-header">
      <div class="stock-name-block">
        <h3>${s.name}</h3>
        <p>${s.symbol} ¬∑ ${s.currency}</p>
      </div>
      <div class="price-block">
        <div class="price">${fmt(m.previousClose,"",2)}</div>
        <div class="currency">${s.currency}</div>
      </div>
    </div>
    <div class="overall-score">
      <div class="num">${s.score}</div>
      <div class="lbl">${scoreLabel}</div>
      <div class="desc">Gesamtscore (max. ~100 Pkt.)</div>
    </div>
    <div class="metrics-grid">${metricsHTML}</div>
    <button class="add-wl-btn ${inWL ? 'added' : ''}" id="add-wl-btn"
      onclick="toggleWatchlist(${JSON.stringify(s).replace(/"/g,'&quot;')})">
      ${inWL ? "‚úì In Watchlist" : "+ Zur Watchlist hinzuf√ºgen"}
    </button>
  `;
}

/* ‚îÄ‚îÄ Watchlist ‚îÄ‚îÄ */
function toggleWatchlist(s) {
  const idx = watchlist.findIndex(w => w.symbol === s.symbol);
  if (idx >= 0) {
    watchlist.splice(idx, 1);
  } else {
    watchlist.push({ symbol: s.symbol, name: s.name, score: s.score });
  }
  localStorage.setItem("wl", JSON.stringify(watchlist));
  renderWatchlist();
  // Update button
  const btn = document.getElementById("add-wl-btn");
  const inWL = watchlist.some(w => w.symbol === s.symbol);
  if (btn) {
    btn.textContent = inWL ? "‚úì In Watchlist" : "+ Zur Watchlist hinzuf√ºgen";
    btn.className = "add-wl-btn" + (inWL ? " added" : "");
  }
}

document.getElementById("clear-wl").addEventListener("click", () => {
  watchlist = [];
  localStorage.setItem("wl", "[]");
  renderWatchlist();
});

function renderWatchlist() {
  const el = document.getElementById("watchlist");
  if (!watchlist.length) {
    el.innerHTML = '<div class="empty-msg">Noch keine Aktien gespeichert</div>';
    return;
  }
  el.innerHTML = watchlist.map(w => `
    <div class="wl-item" onclick="loadFromWatchlist('${w.symbol}')">
      <span class="wl-symbol">${w.symbol}</span>
      <span style="font-size:.85em;color:var(--muted);flex:1;">${w.name}</span>
      <span class="wl-score">${w.score}</span>
      <button class="wl-remove" onclick="event.stopPropagation();removeWL('${w.symbol}')">‚úï</button>
    </div>
  `).join("");
}

function loadFromWatchlist(sym) {
  if (!DB) return;
  for (const mkt of Object.values(DB.markets)) {
    const s = mkt.stocks.find(x => x.symbol === sym);
    if (s) { showStockFromDB(s); return; }
  }
}

function removeWL(sym) {
  watchlist = watchlist.filter(w => w.symbol !== sym);
  localStorage.setItem("wl", JSON.stringify(watchlist));
  renderWatchlist();
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
renderWatchlist();
loadData();
</script>
</body>
</html>
